<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Optimizing a modular robot for locomotion using CPPNWIN and Isaac Gym &mdash; revolve2 v0.3.5-beta1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.png"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="revolve2 namespace" href="../api_reference/revolve2.html" />
    <link rel="prev" title="Creating a modular robot and simulating and visualizing it in the Isaac Gym environment" href="simulate_robot_isaac.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> revolve2
            <img src="../_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation/index.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../installation/runners/isaacgym.html">Isaac Gym physics runner</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation/runners/mujoco.html">Mujoco physics runner</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation/genotypes/cppnwin.html">CPPNWIN genotype</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation/rpi_controller.html">Raspberry Pi actor controller</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user_guide/index.html">User Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user_guide/optimization.html">Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user_guide/database.html">Database</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user_guide/physics_runners.html">Physics runners</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user_guide/modular_robots.html">Modular robots</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user_guide/rpi_controller.html">Raspberry Pi actor controller</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="simple_optimization.html">A simple optimization process with a database</a></li>
<li class="toctree-l2"><a class="reference internal" href="simulate_robot_isaac.html">Creating a modular robot and simulating and visualizing it in the Isaac Gym environment</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Optimizing a modular robot for locomotion using CPPNWIN and Isaac Gym</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api_reference/revolve2.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../api_reference/revolve2.core.html">core</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api_reference/revolve2.core.database.html">database</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api_reference/revolve2.core.database.serializers.html">serializers</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api_reference/revolve2.core.modular_robot.html">modular_robot</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api_reference/revolve2.core.modular_robot.brains.html">brains</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api_reference/revolve2.core.optimization.html">optimization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api_reference/revolve2.core.optimization.ea.html">ea</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api_reference/revolve2.core.physics.html">physics</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api_reference/revolve2.core.physics.actor.html">actor</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api_reference/revolve2.core.physics.running.html">running</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api_reference/revolve2.core.rpi_controller_remote.html">rpi_controller_remote</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api_reference/revolve2.serialization.html">serialization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_reference/revolve2.genotypes.html">genotypes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api_reference/revolve2.genotypes.cppnwin.html">cppnwin</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api_reference/revolve2.genotypes.cppnwin.modular_robot.html">modular_robot</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api_reference/revolve2.runners.html">runners</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api_reference/revolve2.runners.isaacgym.html">isaacgym</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api_reference/revolve2.actor_controller.html">actor_controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_reference/revolve2.actor_controllers.html">actor_controllers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api_reference/revolve2.actor_controllers.cpg.html">cpg</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api_reference/revolve2.bin.html">bin</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api_reference/revolve2.bin.core.html">core</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api_reference/revolve2.bin.core.optimization.html">optimization</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api_reference/revolve2.bin.rpi_controller.html">rpi_controller</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../development_guide/index.html">Development guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">revolve2</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Tutorials</a> &raquo;</li>
      <li>Optimizing a modular robot for locomotion using CPPNWIN and Isaac Gym</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="optimizing-a-modular-robot-for-locomotion-using-cppnwin-and-isaac-gym">
<h1>Optimizing a modular robot for locomotion using CPPNWIN and Isaac Gym<a class="headerlink" href="#optimizing-a-modular-robot-for-locomotion-using-cppnwin-and-isaac-gym" title="Permalink to this heading"></a></h1>
<p>The final results of this tutorial are available at <code class="docutils literal notranslate"><span class="pre">&lt;revolve2_source&gt;/examples/optimize_modular&gt;</span></code>.</p>
<section id="what-you-will-learn">
<h2>What you will learn<a class="headerlink" href="#what-you-will-learn" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p>How to use the <code class="docutils literal notranslate"><span class="pre">CPPNWIN</span></code> genotype supplementary package.</p></li>
<li><p>How to combine modular robots with evolutionary optimization.</p></li>
<li><p>How to manually insert into a database.</p></li>
</ul>
</section>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p>Tutorial <a class="reference internal" href="simple_optimization.html#a-simple-optimization-process-with-a-database"><span class="std std-ref">A simple optimization process with a database</span></a></p></li>
<li><p>Tutorial <a class="reference internal" href="simulate_robot_isaac.html#creating-a-modular-robot-and-simulating-and-visualizing-it-in-the-isaac-gym-environment"><span class="std std-ref">Creating a modular robot and simulating and visualizing it in the Isaac Gym environment</span></a></p></li>
<li><p>Have the supplementary package <code class="docutils literal notranslate"><span class="pre">genotype</span> <span class="pre">CPPNWIN</span></code> <a class="reference internal" href="../installation/genotypes/cppnwin.html#cppnwin-genotype"><span class="std std-ref">installed</span></a>.</p></li>
<li><p>Superficial knowledge of the CPPNWIN genotype, used by ci-group.</p></li>
</ul>
</section>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h2>
<p>You will create a program that optimizes a modular robot body and brain for undirected locomotion.
That is, a robot that moves as far as possible, no matter the direction.</p>
</section>
<section id="programming-it">
<h2>Programming it<a class="headerlink" href="#programming-it" title="Permalink to this heading"></a></h2>
<p>The code you will write is incrediby similar to the <code class="docutils literal notranslate"><span class="pre">simple</span> <span class="pre">optimization</span></code> tutorial. As with that tutorial it will be convenient to seperate your code in multiple files.
Create an empty directory and a file <code class="docutils literal notranslate"><span class="pre">optimize.py</span></code>. This will be your program’s entry point.
The baseline code for this program is similar to the previous tutorials’:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># optimize.py</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">Random</span>
<span class="kn">from</span> <span class="nn">revolve2.core.database.sqlite</span> <span class="kn">import</span> <span class="n">Database</span> <span class="k">as</span> <span class="n">DbSqlite</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">POPULATION_SIZE</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">OFFSPRING_SIZE</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">NUM_GENERATIONS</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
        <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
        <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;[</span><span class="si">%(asctime)s</span><span class="s2">] [</span><span class="si">%(levelname)s</span><span class="s2">] [</span><span class="si">%(module)s</span><span class="s2">] </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting optimization&quot;</span><span class="p">)</span>

    <span class="c1"># random number generator</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">Random</span><span class="p">()</span>
    <span class="n">rng</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

    <span class="c1"># database</span>
    <span class="n">database</span> <span class="o">=</span> <span class="k">await</span> <span class="n">DbSqlite</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;database&quot;</span><span class="p">)</span>

    <span class="c1"># here you will add your initial population and optimizer later</span>
    <span class="c1"># ...</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting optimization process..&quot;</span><span class="p">)</span>

    <span class="c1"># await ep.run()</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished optimizing.&quot;</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">asyncio</span>

    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>
</div>
<section id="the-genotype">
<h3>The genotype<a class="headerlink" href="#the-genotype" title="Permalink to this heading"></a></h3>
<p>Start by creating a genotype in a new file called <code class="docutils literal notranslate"><span class="pre">genotype.py</span></code>.
Let it be the composite of a body and brain genotype, both of type <code class="docutils literal notranslate"><span class="pre">CPPNWIN</span></code>, which is a genotype provided by Revolve2.
The library also provides a serializer for the CPPNWIN genotype, so creating a serializer for the composite genotype should be trivial:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># genotype.py</span>

<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">revolve2.genotypes.cppnwin</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Genotype</span> <span class="k">as</span> <span class="n">CppnwinGenotype</span><span class="p">,</span>
    <span class="n">GenotypeSerializer</span> <span class="k">as</span> <span class="n">CppnwinGenotypeSerializer</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">revolve2.core.database</span> <span class="kn">import</span> <span class="n">Serializer</span><span class="p">,</span> <span class="n">IncompatibleError</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.asyncio.session</span> <span class="kn">import</span> <span class="n">AsyncSession</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.future</span> <span class="kn">import</span> <span class="n">select</span>
<span class="kn">import</span> <span class="nn">sqlalchemy</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Genotype</span><span class="p">:</span>
    <span class="n">body</span><span class="p">:</span> <span class="n">CppnwinGenotype</span>
    <span class="n">brain</span><span class="p">:</span> <span class="n">CppnwinGenotype</span>


<span class="k">class</span> <span class="nc">GenotypeSerializer</span><span class="p">(</span><span class="n">Serializer</span><span class="p">[</span><span class="n">Genotype</span><span class="p">]):</span>
    <span class="nd">@classmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">create_tables</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">await</span> <span class="p">(</span><span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">connection</span><span class="p">())</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">DbBase</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">CppnwinGenotypeSerializer</span><span class="o">.</span><span class="n">create_tables</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">identifying_table</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">DbGenotype</span><span class="o">.</span><span class="n">__tablename__</span>

    <span class="nd">@classmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">to_database</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">objects</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Genotype</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="n">body_ids</span> <span class="o">=</span> <span class="k">await</span> <span class="n">CppnwinGenotypeSerializer</span><span class="o">.</span><span class="n">to_database</span><span class="p">(</span>
            <span class="n">session</span><span class="p">,</span> <span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">body</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">brain_ids</span> <span class="o">=</span> <span class="k">await</span> <span class="n">CppnwinGenotypeSerializer</span><span class="o">.</span><span class="n">to_database</span><span class="p">(</span>
            <span class="n">session</span><span class="p">,</span> <span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">brain</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">dbgenotypes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">DbGenotype</span><span class="p">(</span><span class="n">body_id</span><span class="o">=</span><span class="n">body_id</span><span class="p">,</span> <span class="n">brain_id</span><span class="o">=</span><span class="n">brain_id</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">body_id</span><span class="p">,</span> <span class="n">brain_id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">body_ids</span><span class="p">,</span> <span class="n">brain_ids</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">session</span><span class="o">.</span><span class="n">add_all</span><span class="p">(</span><span class="n">dbgenotypes</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">dbfitness</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">dbfitness</span> <span class="ow">in</span> <span class="n">dbgenotypes</span> <span class="k">if</span> <span class="n">dbfitness</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">]</span>  <span class="c1"># cannot be none because not nullable. check if only there to silence mypy.</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>  <span class="c1"># but check just to be sure</span>
        <span class="k">return</span> <span class="n">ids</span>

    <span class="nd">@classmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">from_database</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Genotype</span><span class="p">]:</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">DbGenotype</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">DbGenotype</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">ids</span><span class="p">))))</span>
            <span class="o">.</span><span class="n">scalars</span><span class="p">()</span>
            <span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">IncompatibleError</span><span class="p">()</span>

        <span class="n">id_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">}</span>
        <span class="n">body_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">id_map</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">body_id</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]</span>
        <span class="n">brain_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">id_map</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">brain_id</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]</span>

        <span class="n">body_genotypes</span> <span class="o">=</span> <span class="k">await</span> <span class="n">CppnwinGenotypeSerializer</span><span class="o">.</span><span class="n">from_database</span><span class="p">(</span>
            <span class="n">session</span><span class="p">,</span> <span class="n">body_ids</span>
        <span class="p">)</span>
        <span class="n">brain_genotypes</span> <span class="o">=</span> <span class="k">await</span> <span class="n">CppnwinGenotypeSerializer</span><span class="o">.</span><span class="n">from_database</span><span class="p">(</span>
            <span class="n">session</span><span class="p">,</span> <span class="n">brain_ids</span>
        <span class="p">)</span>

        <span class="n">genotypes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Genotype</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">brain</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">body</span><span class="p">,</span> <span class="n">brain</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">body_genotypes</span><span class="p">,</span> <span class="n">brain_genotypes</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="n">genotypes</span>


<span class="n">DbBase</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">DbGenotype</span><span class="p">(</span><span class="n">DbBase</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;genotype&quot;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">autoincrement</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">body_id</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">brain_id</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>For the random initialization of the genotype you need to dive into <code class="docutils literal notranslate"><span class="pre">MultiNEAT</span></code>.
MultiNEAT is the C++ implementation behind CPPNWIN.
You need to interact with this library because you need to determine the parameters used for creating the CPPN network,
and because you need to create a random object that MultiNEAT understand.
The latter is easy, as you can simply instantiate a MultiNEAT random object and seed it with a random integer obtained from the Python random object.
The MultiNEAT <code class="docutils literal notranslate"><span class="pre">parameters</span></code> are more complex, but this tutorial will give you a starting point. For more options refer to the MultiNEAT documentation.
You also need parameters for the MultiNEAT innovation databases, one for body and one for brain:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">multineat</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">Random</span>
<span class="kn">from</span> <span class="nn">revolve2.genotypes.cppnwin.modular_robot.body_genotype_v1</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">random_v1</span> <span class="k">as</span> <span class="n">body_random</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">revolve2.genotypes.cppnwin.modular_robot.brain_genotype_cpg_v1</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">random_v1</span> <span class="k">as</span> <span class="n">brain_random</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># ...</span>

<span class="k">def</span> <span class="nf">random</span><span class="p">(</span>
    <span class="n">innov_db_body</span><span class="p">:</span> <span class="n">multineat</span><span class="o">.</span><span class="n">InnovationDatabase</span><span class="p">,</span>
    <span class="n">innov_db_brain</span><span class="p">:</span> <span class="n">multineat</span><span class="o">.</span><span class="n">InnovationDatabase</span><span class="p">,</span>
    <span class="n">rng</span><span class="p">:</span> <span class="n">Random</span><span class="p">,</span>
    <span class="n">num_initial_mutations</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Genotype</span><span class="p">:</span>
    <span class="n">multineat_rng</span> <span class="o">=</span> <span class="n">_multineat_rng_from_random</span><span class="p">(</span><span class="n">rng</span><span class="p">)</span>

    <span class="n">body</span> <span class="o">=</span> <span class="n">body_random</span><span class="p">(</span>
        <span class="n">innov_db_body</span><span class="p">,</span>
        <span class="n">multineat_rng</span><span class="p">,</span>
        <span class="n">_MULTINEAT_PARAMS</span><span class="p">,</span>
        <span class="n">multineat</span><span class="o">.</span><span class="n">ActivationFunction</span><span class="o">.</span><span class="n">TANH</span><span class="p">,</span>
        <span class="n">num_initial_mutations</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">brain</span> <span class="o">=</span> <span class="n">brain_random</span><span class="p">(</span>
        <span class="n">innov_db_brain</span><span class="p">,</span>
        <span class="n">multineat_rng</span><span class="p">,</span>
        <span class="n">_MULTINEAT_PARAMS</span><span class="p">,</span>
        <span class="n">multineat</span><span class="o">.</span><span class="n">ActivationFunction</span><span class="o">.</span><span class="n">SIGNED_SINE</span><span class="p">,</span>
        <span class="n">num_initial_mutations</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">Genotype</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">brain</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_multineat_rng_from_random</span><span class="p">(</span><span class="n">rng</span><span class="p">:</span> <span class="n">Random</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">multineat</span><span class="o">.</span><span class="n">RNG</span><span class="p">:</span>
    <span class="n">multineat_rng</span> <span class="o">=</span> <span class="n">multineat</span><span class="o">.</span><span class="n">RNG</span><span class="p">()</span>
    <span class="n">multineat_rng</span><span class="o">.</span><span class="n">Seed</span><span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="mi">31</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">multineat_rng</span>

<span class="k">def</span> <span class="nf">_make_multineat_params</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">multineat</span><span class="o">.</span><span class="n">Parameters</span><span class="p">:</span>
    <span class="n">multineat_params</span> <span class="o">=</span> <span class="n">multineat</span><span class="o">.</span><span class="n">Parameters</span><span class="p">()</span>

    <span class="n">multineat_params</span><span class="o">.</span><span class="n">MutateRemLinkProb</span> <span class="o">=</span> <span class="mf">0.02</span>
    <span class="n">multineat_params</span><span class="o">.</span><span class="n">RecurrentProb</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">multineat_params</span><span class="o">.</span><span class="n">OverallMutationRate</span> <span class="o">=</span> <span class="mf">0.15</span>
    <span class="n">multineat_params</span><span class="o">.</span><span class="n">MutateAddLinkProb</span> <span class="o">=</span> <span class="mf">0.08</span>
    <span class="n">multineat_params</span><span class="o">.</span><span class="n">MutateAddNeuronProb</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">multineat_params</span><span class="o">.</span><span class="n">MutateWeightsProb</span> <span class="o">=</span> <span class="mf">0.90</span>
    <span class="n">multineat_params</span><span class="o">.</span><span class="n">MaxWeight</span> <span class="o">=</span> <span class="mf">8.0</span>
    <span class="n">multineat_params</span><span class="o">.</span><span class="n">WeightMutationMaxPower</span> <span class="o">=</span> <span class="mf">0.2</span>
    <span class="n">multineat_params</span><span class="o">.</span><span class="n">WeightReplacementMaxPower</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">multineat_params</span><span class="o">.</span><span class="n">MutateActivationAProb</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">multineat_params</span><span class="o">.</span><span class="n">ActivationAMutationMaxPower</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">multineat_params</span><span class="o">.</span><span class="n">MinActivationA</span> <span class="o">=</span> <span class="mf">0.05</span>
    <span class="n">multineat_params</span><span class="o">.</span><span class="n">MaxActivationA</span> <span class="o">=</span> <span class="mf">6.0</span>

    <span class="n">multineat_params</span><span class="o">.</span><span class="n">MutateNeuronActivationTypeProb</span> <span class="o">=</span> <span class="mf">0.03</span>

    <span class="n">multineat_params</span><span class="o">.</span><span class="n">MutateOutputActivationFunction</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">multineat_params</span><span class="o">.</span><span class="n">ActivationFunction_SignedSigmoid_Prob</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">multineat_params</span><span class="o">.</span><span class="n">ActivationFunction_UnsignedSigmoid_Prob</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">multineat_params</span><span class="o">.</span><span class="n">ActivationFunction_Tanh_Prob</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">multineat_params</span><span class="o">.</span><span class="n">ActivationFunction_TanhCubic_Prob</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">multineat_params</span><span class="o">.</span><span class="n">ActivationFunction_SignedStep_Prob</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">multineat_params</span><span class="o">.</span><span class="n">ActivationFunction_UnsignedStep_Prob</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">multineat_params</span><span class="o">.</span><span class="n">ActivationFunction_SignedGauss_Prob</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">multineat_params</span><span class="o">.</span><span class="n">ActivationFunction_UnsignedGauss_Prob</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">multineat_params</span><span class="o">.</span><span class="n">ActivationFunction_Abs_Prob</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">multineat_params</span><span class="o">.</span><span class="n">ActivationFunction_SignedSine_Prob</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">multineat_params</span><span class="o">.</span><span class="n">ActivationFunction_UnsignedSine_Prob</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">multineat_params</span><span class="o">.</span><span class="n">ActivationFunction_Linear_Prob</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="n">multineat_params</span><span class="o">.</span><span class="n">MutateNeuronTraitsProb</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">multineat_params</span><span class="o">.</span><span class="n">MutateLinkTraitsProb</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="n">multineat_params</span><span class="o">.</span><span class="n">AllowLoops</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">multineat_params</span>

<span class="n">_MULTINEAT_PARAMS</span> <span class="o">=</span> <span class="n">_make_multineat_params</span><span class="p">()</span>
</pre></div>
</div>
<p>Mutation is straightforward. Create a new instance of your <code class="docutils literal notranslate"><span class="pre">Genotype</span></code> class and use the <code class="docutils literal notranslate"><span class="pre">mutate</span></code> functions on your body and brain genotypes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">revolve2.genotypes.cppnwin</span> <span class="kn">import</span> <span class="n">mutate_v1</span>

<span class="c1"># ...</span>

<span class="k">def</span> <span class="nf">mutate</span><span class="p">(</span>
    <span class="n">genotype</span><span class="p">:</span> <span class="n">Genotype</span><span class="p">,</span>
    <span class="n">innov_db_body</span><span class="p">:</span> <span class="n">multineat</span><span class="o">.</span><span class="n">InnovationDatabase</span><span class="p">,</span>
    <span class="n">innov_db_brain</span><span class="p">:</span> <span class="n">multineat</span><span class="o">.</span><span class="n">InnovationDatabase</span><span class="p">,</span>
    <span class="n">rng</span><span class="p">:</span> <span class="n">Random</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Genotype</span><span class="p">:</span>
    <span class="n">multineat_rng</span> <span class="o">=</span> <span class="n">_multineat_rng_from_random</span><span class="p">(</span><span class="n">rng</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Genotype</span><span class="p">(</span>
        <span class="n">mutate_v1</span><span class="p">(</span><span class="n">genotype</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">_MULTINEAT_PARAMS</span><span class="p">,</span> <span class="n">innov_db_body</span><span class="p">,</span> <span class="n">multineat_rng</span><span class="p">),</span>
        <span class="n">mutate_v1</span><span class="p">(</span><span class="n">genotype</span><span class="o">.</span><span class="n">brain</span><span class="p">,</span> <span class="n">_MULTINEAT_PARAMS</span><span class="p">,</span> <span class="n">innov_db_brain</span><span class="p">,</span> <span class="n">multineat_rng</span><span class="p">),</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>Crossover is very similar. The CPNNWIN crossover function takes some extra parameters that are irrelevant for now. Take a look at the documentation if you are interested:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">revolve2.genotypes.cppnwin</span> <span class="kn">import</span> <span class="n">crossover_v1</span>

<span class="k">def</span> <span class="nf">crossover</span><span class="p">(</span>
    <span class="n">parent1</span><span class="p">:</span> <span class="n">Genotype</span><span class="p">,</span>
    <span class="n">parent2</span><span class="p">:</span> <span class="n">Genotype</span><span class="p">,</span>
    <span class="n">rng</span><span class="p">:</span> <span class="n">Random</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Genotype</span><span class="p">:</span>
    <span class="n">multineat_rng</span> <span class="o">=</span> <span class="n">_multineat_rng_from_random</span><span class="p">(</span><span class="n">rng</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Genotype</span><span class="p">(</span>
        <span class="n">crossover_v1</span><span class="p">(</span>
            <span class="n">parent1</span><span class="o">.</span><span class="n">body</span><span class="p">,</span>
            <span class="n">parent2</span><span class="o">.</span><span class="n">body</span><span class="p">,</span>
            <span class="n">_MULTINEAT_PARAMS</span><span class="p">,</span>
            <span class="n">multineat_rng</span><span class="p">,</span>
            <span class="kc">False</span><span class="p">,</span>
            <span class="kc">False</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">crossover_v1</span><span class="p">(</span>
            <span class="n">parent1</span><span class="o">.</span><span class="n">brain</span><span class="p">,</span>
            <span class="n">parent2</span><span class="o">.</span><span class="n">brain</span><span class="p">,</span>
            <span class="n">_MULTINEAT_PARAMS</span><span class="p">,</span>
            <span class="n">multineat_rng</span><span class="p">,</span>
            <span class="kc">False</span><span class="p">,</span>
            <span class="kc">False</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>Development into a <code class="docutils literal notranslate"><span class="pre">ModularRobot</span></code> is readily available in Revolve2:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">revolve2.genotypes.cppnwin.modular_robot.body_genotype_v1</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">develop_v1</span> <span class="k">as</span> <span class="n">body_develop</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">revolve2.genotypes.cppnwin.modular_robot.brain_genotype_cpg_v1</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">develop_v1</span> <span class="k">as</span> <span class="n">brain_develop</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">revolve2.core.modular_robot</span> <span class="kn">import</span> <span class="n">ModularRobot</span>

<span class="c1"># ...</span>

<span class="k">def</span> <span class="nf">develop</span><span class="p">(</span><span class="n">genotype</span><span class="p">:</span> <span class="n">Genotype</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ModularRobot</span><span class="p">:</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">body_develop</span><span class="p">(</span><span class="n">genotype</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
    <span class="n">brain</span> <span class="o">=</span> <span class="n">brain_develop</span><span class="p">(</span><span class="n">genotype</span><span class="o">.</span><span class="n">brain</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ModularRobot</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">brain</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="the-optimizer">
<h3>The optimizer<a class="headerlink" href="#the-optimizer" title="Permalink to this heading"></a></h3>
<p>The optimizer will look similar to the optimizer from the previous evolutionary optimization tutorial.
Add the innovation databases, as they will be shared between all genotypes.
Additionally, instead of a single controller you will store a controller for each individual robot.
Finally, you can save some of the parameters provided to <code class="docutils literal notranslate"><span class="pre">ainit_new</span></code> in the database so they don’t have to be provided again when loading from the database:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># optimizer.py</span>

<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">Random</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">multineat</span>
<span class="kn">from</span> <span class="nn">genotype</span> <span class="kn">import</span> <span class="n">Genotype</span><span class="p">,</span> <span class="n">GenotypeSerializer</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>
<span class="kn">import</span> <span class="nn">sqlalchemy</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.asyncio</span> <span class="kn">import</span> <span class="n">AsyncEngine</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.asyncio.session</span> <span class="kn">import</span> <span class="n">AsyncSession</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.future</span> <span class="kn">import</span> <span class="n">select</span>

<span class="kn">import</span> <span class="nn">revolve2.core.optimization.ea.generic_ea.population_management</span> <span class="k">as</span> <span class="nn">population_management</span>
<span class="kn">import</span> <span class="nn">revolve2.core.optimization.ea.generic_ea.selection</span> <span class="k">as</span> <span class="nn">selection</span>
<span class="kn">from</span> <span class="nn">revolve2.actor_controller</span> <span class="kn">import</span> <span class="n">ActorController</span>
<span class="kn">from</span> <span class="nn">revolve2.core.database</span> <span class="kn">import</span> <span class="n">IncompatibleError</span>
<span class="kn">from</span> <span class="nn">revolve2.core.database.serializers</span> <span class="kn">import</span> <span class="n">FloatSerializer</span>
<span class="kn">from</span> <span class="nn">revolve2.core.optimization</span> <span class="kn">import</span> <span class="n">DbId</span>
<span class="kn">from</span> <span class="nn">revolve2.core.optimization.ea.generic_ea</span> <span class="kn">import</span> <span class="n">EAOptimizer</span>
<span class="kn">from</span> <span class="nn">revolve2.core.physics.running</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ActorControl</span><span class="p">,</span>
    <span class="n">Runner</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">revolve2.runners.mujoco</span> <span class="kn">import</span> <span class="n">LocalRunner</span>

<span class="k">class</span> <span class="nc">Optimizer</span><span class="p">(</span><span class="n">EAOptimizer</span><span class="p">[</span><span class="n">Genotype</span><span class="p">,</span> <span class="nb">float</span><span class="p">]):</span>
    <span class="n">_db_id</span><span class="p">:</span> <span class="n">DbId</span>

    <span class="n">_runner</span><span class="p">:</span> <span class="n">Runner</span>

    <span class="n">_controllers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ActorController</span><span class="p">]</span>

    <span class="n">_innov_db_body</span><span class="p">:</span> <span class="n">multineat</span><span class="o">.</span><span class="n">InnovationDatabase</span>
    <span class="n">_innov_db_brain</span><span class="p">:</span> <span class="n">multineat</span><span class="o">.</span><span class="n">InnovationDatabase</span>

    <span class="n">_rng</span><span class="p">:</span> <span class="n">Random</span>

    <span class="n">_simulation_time</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">_sampling_frequency</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">_control_frequency</span><span class="p">:</span> <span class="nb">float</span>

    <span class="n">_num_generations</span><span class="p">:</span> <span class="nb">int</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">ainit_new</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">database</span><span class="p">:</span> <span class="n">AsyncEngine</span><span class="p">,</span>
        <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span>
        <span class="n">db_id</span><span class="p">:</span> <span class="n">DbId</span><span class="p">,</span>
        <span class="n">initial_population</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Genotype</span><span class="p">],</span>
        <span class="n">rng</span><span class="p">:</span> <span class="n">Random</span><span class="p">,</span>
        <span class="n">innov_db_body</span><span class="p">:</span> <span class="n">multineat</span><span class="o">.</span><span class="n">InnovationDatabase</span><span class="p">,</span>
        <span class="n">innov_db_brain</span><span class="p">:</span> <span class="n">multineat</span><span class="o">.</span><span class="n">InnovationDatabase</span><span class="p">,</span>
        <span class="n">simulation_time</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">sampling_frequency</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">control_frequency</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">num_generations</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">offspring_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">ainit_new</span><span class="p">(</span>
            <span class="n">database</span><span class="o">=</span><span class="n">database</span><span class="p">,</span>
            <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
            <span class="n">db_id</span><span class="o">=</span><span class="n">db_id</span><span class="p">,</span>
            <span class="n">genotype_type</span><span class="o">=</span><span class="n">Genotype</span><span class="p">,</span>
            <span class="n">genotype_serializer</span><span class="o">=</span><span class="n">GenotypeSerializer</span><span class="p">,</span>
            <span class="n">fitness_type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
            <span class="n">fitness_serializer</span><span class="o">=</span><span class="n">FloatSerializer</span><span class="p">,</span>
            <span class="n">offspring_size</span><span class="o">=</span><span class="n">offspring_size</span><span class="p">,</span>
            <span class="n">initial_population</span><span class="o">=</span><span class="n">initial_population</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_db_id</span> <span class="o">=</span> <span class="n">db_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_runner</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_innov_db_body</span> <span class="o">=</span> <span class="n">innov_db_body</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_innov_db_brain</span> <span class="o">=</span> <span class="n">innov_db_brain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rng</span> <span class="o">=</span> <span class="n">rng</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_time</span> <span class="o">=</span> <span class="n">simulation_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sampling_frequency</span> <span class="o">=</span> <span class="n">sampling_frequency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_control_frequency</span> <span class="o">=</span> <span class="n">control_frequency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_generations</span> <span class="o">=</span> <span class="n">num_generations</span>

        <span class="c1"># create database structure if not exists</span>
        <span class="k">await</span> <span class="p">(</span><span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">connection</span><span class="p">())</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">DbBase</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">)</span>

        <span class="c1"># save to database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_on_generation_checkpoint</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">ainit_from_database</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">database</span><span class="p">:</span> <span class="n">AsyncEngine</span><span class="p">,</span>
        <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span>
        <span class="n">db_id</span><span class="p">:</span> <span class="n">DbId</span><span class="p">,</span>
        <span class="n">rng</span><span class="p">:</span> <span class="n">Random</span><span class="p">,</span>
        <span class="n">innov_db_body</span><span class="p">:</span> <span class="n">multineat</span><span class="o">.</span><span class="n">InnovationDatabase</span><span class="p">,</span>
        <span class="n">innov_db_brain</span><span class="p">:</span> <span class="n">multineat</span><span class="o">.</span><span class="n">InnovationDatabase</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">ainit_from_database</span><span class="p">(</span>
            <span class="n">database</span><span class="o">=</span><span class="n">database</span><span class="p">,</span>
            <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
            <span class="n">db_id</span><span class="o">=</span><span class="n">db_id</span><span class="p">,</span>
            <span class="n">genotype_type</span><span class="o">=</span><span class="n">Genotype</span><span class="p">,</span>
            <span class="n">genotype_serializer</span><span class="o">=</span><span class="n">GenotypeSerializer</span><span class="p">,</span>
            <span class="n">fitness_type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
            <span class="n">fitness_serializer</span><span class="o">=</span><span class="n">FloatSerializer</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_db_id</span> <span class="o">=</span> <span class="n">db_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_runner</span><span class="p">()</span>

        <span class="n">opt_row</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span>
                <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="n">select</span><span class="p">(</span><span class="n">DbOptimizerState</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">DbOptimizerState</span><span class="o">.</span><span class="n">db_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_id</span><span class="o">.</span><span class="n">fullname</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">DbOptimizerState</span><span class="o">.</span><span class="n">generation_index</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">scalars</span><span class="p">()</span>
            <span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># if this happens something is wrong with the database</span>
        <span class="k">if</span> <span class="n">opt_row</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">IncompatibleError</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_time</span> <span class="o">=</span> <span class="n">opt_row</span><span class="o">.</span><span class="n">simulation_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sampling_frequency</span> <span class="o">=</span> <span class="n">opt_row</span><span class="o">.</span><span class="n">sampling_frequency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_control_frequency</span> <span class="o">=</span> <span class="n">opt_row</span><span class="o">.</span><span class="n">control_frequency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_generations</span> <span class="o">=</span> <span class="n">opt_row</span><span class="o">.</span><span class="n">num_generations</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_rng</span> <span class="o">=</span> <span class="n">rng</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rng</span><span class="o">.</span><span class="n">setstate</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">opt_row</span><span class="o">.</span><span class="n">rng</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_innov_db_body</span> <span class="o">=</span> <span class="n">innov_db_body</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_innov_db_body</span><span class="o">.</span><span class="n">Deserialize</span><span class="p">(</span><span class="n">opt_row</span><span class="o">.</span><span class="n">innov_db_body</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_innov_db_brain</span> <span class="o">=</span> <span class="n">innov_db_brain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_innov_db_brain</span><span class="o">.</span><span class="n">Deserialize</span><span class="p">(</span><span class="n">opt_row</span><span class="o">.</span><span class="n">innov_db_brain</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_init_runner</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_runner</span> <span class="o">=</span> <span class="n">LocalRunner</span><span class="p">(</span><span class="n">headless</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_select_parents</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">population</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Genotype</span><span class="p">],</span>
        <span class="n">fitnesses</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">num_parent_groups</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">selection</span><span class="o">.</span><span class="n">multiple_unique</span><span class="p">(</span>
                <span class="mi">2</span><span class="p">,</span>
                <span class="n">population</span><span class="p">,</span>
                <span class="n">fitnesses</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="n">_</span><span class="p">,</span> <span class="n">fitnesses</span><span class="p">:</span> <span class="n">selection</span><span class="o">.</span><span class="n">tournament</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rng</span><span class="p">,</span> <span class="n">fitnesses</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_parent_groups</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">_select_survivors</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">old_individuals</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Genotype</span><span class="p">],</span>
        <span class="n">old_fitnesses</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">new_individuals</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Genotype</span><span class="p">],</span>
        <span class="n">new_fitnesses</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">num_survivors</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_individuals</span><span class="p">)</span> <span class="o">==</span> <span class="n">num_survivors</span>

        <span class="k">return</span> <span class="n">population_management</span><span class="o">.</span><span class="n">steady_state</span><span class="p">(</span>
            <span class="n">old_individuals</span><span class="p">,</span>
            <span class="n">old_fitnesses</span><span class="p">,</span>
            <span class="n">new_individuals</span><span class="p">,</span>
            <span class="n">new_fitnesses</span><span class="p">,</span>
            <span class="k">lambda</span> <span class="n">_</span><span class="p">,</span> <span class="n">fitnesses</span><span class="p">:</span> <span class="n">selection</span><span class="o">.</span><span class="n">tournament</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rng</span><span class="p">,</span> <span class="n">fitnesses</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_must_do_next_gen</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">generation_index</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_generations</span>

    <span class="k">def</span> <span class="nf">_on_generation_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="n">DbOptimizerState</span><span class="p">(</span>
                <span class="n">db_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_id</span><span class="o">.</span><span class="n">fullname</span><span class="p">,</span>
                <span class="n">generation_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">generation_index</span><span class="p">,</span>
                <span class="n">rng</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rng</span><span class="o">.</span><span class="n">getstate</span><span class="p">()),</span>
                <span class="n">innov_db_body</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_innov_db_body</span><span class="o">.</span><span class="n">Serialize</span><span class="p">(),</span>
                <span class="n">innov_db_brain</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_innov_db_brain</span><span class="o">.</span><span class="n">Serialize</span><span class="p">(),</span>
                <span class="n">simulation_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_simulation_time</span><span class="p">,</span>
                <span class="n">sampling_frequency</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_sampling_frequency</span><span class="p">,</span>
                <span class="n">control_frequency</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_control_frequency</span><span class="p">,</span>
                <span class="n">num_generations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_generations</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_crossover</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parents</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Genotype</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Genotype</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_mutate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">genotype</span><span class="p">:</span> <span class="n">Genotype</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Genotype</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_evaluate_generation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">genotypes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Genotype</span><span class="p">],</span>
        <span class="n">database</span><span class="p">:</span> <span class="n">AsyncEngine</span><span class="p">,</span>
        <span class="n">db_id</span><span class="p">:</span> <span class="n">DbId</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environment_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">control</span><span class="p">:</span> <span class="n">ActorControl</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>


<span class="n">DbBase</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">DbOptimizerState</span><span class="p">(</span><span class="n">DbBase</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;optimizer&quot;</span>

    <span class="n">db_id</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">String</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">generation_index</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">PickleType</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">innov_db_body</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">innov_db_brain</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">simulation_time</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">sampling_frequency</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">control_frequency</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">num_generations</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">crossover</span></code> and <code class="docutils literal notranslate"><span class="pre">mutate</span></code> can use the functions defined in your <code class="docutils literal notranslate"><span class="pre">Genotype</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">genotype</span> <span class="kn">import</span> <span class="n">crossover</span><span class="p">,</span> <span class="n">mutate</span>

<span class="c1"># ...</span>

<span class="k">def</span> <span class="nf">_crossover</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parents</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Genotype</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Genotype</span><span class="p">:</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">parents</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">crossover</span><span class="p">(</span><span class="n">parents</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parents</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rng</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_mutate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">genotype</span><span class="p">:</span> <span class="n">Genotype</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Genotype</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">mutate</span><span class="p">(</span><span class="n">genotype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_innov_db_body</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_innov_db_brain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rng</span><span class="p">)</span>
</pre></div>
</div>
<p>Evaluation works similar to the simulator created in the previous Isaac Gym environment tutorial, with two small differences.
Firstly, there are multiple robots. Store the controllers in their array and call all of them in the control function.
Secondly, the robots have unpredicatable bodies, so use the modular robot’s built-in axis aligned bounding box(aabb) function to find out how high off the ground you need to position it.
And lastly, calculate and return the fitness of the robot, based on the simulation history.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">revolve2.runners.mujoco</span> <span class="kn">import</span> <span class="n">LocalRunner</span>
<span class="kn">from</span> <span class="nn">revolve2.core.physics.running</span> <span class="kn">import</span> <span class="n">Batch</span><span class="p">,</span> <span class="n">Environment</span><span class="p">,</span> <span class="n">PosedActor</span><span class="p">,</span> <span class="n">ActorState</span>
<span class="kn">from</span> <span class="nn">genotype</span> <span class="kn">import</span> <span class="n">develop</span>
<span class="kn">from</span> <span class="nn">pyrr</span> <span class="kn">import</span> <span class="n">Vector3</span><span class="p">,</span> <span class="n">Quaternion</span>

<span class="c1"># ...</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">_evaluate_generation</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">genotypes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Genotype</span><span class="p">],</span>
    <span class="n">database</span><span class="p">:</span> <span class="n">AsyncEngine</span><span class="p">,</span>
    <span class="n">db_id</span><span class="p">:</span> <span class="n">DbId</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="n">Batch</span><span class="p">(</span>
        <span class="n">simulation_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_simulation_time</span><span class="p">,</span>
        <span class="n">sampling_frequency</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_sampling_frequency</span><span class="p">,</span>
        <span class="n">control_frequency</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_control_frequency</span><span class="p">,</span>
        <span class="n">control</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_control</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_controllers</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">genotype</span> <span class="ow">in</span> <span class="n">genotypes</span><span class="p">:</span>
        <span class="n">actor</span><span class="p">,</span> <span class="n">controller</span> <span class="o">=</span> <span class="n">develop</span><span class="p">(</span><span class="n">genotype</span><span class="p">)</span><span class="o">.</span><span class="n">make_actor_and_controller</span><span class="p">()</span>
        <span class="n">bounding_box</span> <span class="o">=</span> <span class="n">actor</span><span class="o">.</span><span class="n">calc_aabb</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_controllers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">()</span>
        <span class="n">env</span><span class="o">.</span><span class="n">actors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">PosedActor</span><span class="p">(</span>
                <span class="n">actor</span><span class="p">,</span>
                <span class="n">Vector3</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="mf">0.0</span><span class="p">,</span>
                        <span class="mf">0.0</span><span class="p">,</span>
                        <span class="n">bounding_box</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">z</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="n">bounding_box</span><span class="o">.</span><span class="n">offset</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">),</span>
                <span class="n">Quaternion</span><span class="p">(),</span>
                <span class="p">[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">controller</span><span class="o">.</span><span class="n">get_dof_targets</span><span class="p">()],</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">environments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

    <span class="n">batch_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runner</span><span class="o">.</span><span class="n">run_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_fitness</span><span class="p">(</span>
            <span class="n">environment_result</span><span class="o">.</span><span class="n">environment_states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">actor_states</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">environment_result</span><span class="o">.</span><span class="n">environment_states</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">actor_states</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">environment_result</span> <span class="ow">in</span> <span class="n">batch_results</span><span class="o">.</span><span class="n">environment_results</span>
    <span class="p">]</span>

<span class="k">def</span> <span class="nf">_control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environment_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">control</span><span class="p">:</span> <span class="n">ActorControl</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">controller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_controllers</span><span class="p">[</span><span class="n">environment_index</span><span class="p">]</span>
    <span class="n">controller</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
    <span class="n">control</span><span class="o">.</span><span class="n">set_dof_targets</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">controller</span><span class="o">.</span><span class="n">get_dof_targets</span><span class="p">())</span>

<span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">_calculate_fitness</span><span class="p">(</span><span class="n">begin_state</span><span class="p">:</span> <span class="n">ActorState</span><span class="p">,</span> <span class="n">end_state</span><span class="p">:</span> <span class="n">ActorState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>
</div>
<p>The last thing you have to do is write the fitness function.
This tutorial simply uses the distance traveled on the xy plane:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">math</span>

<span class="c1"># ...</span>

<span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">_calculate_fitness</span><span class="p">(</span><span class="n">begin_state</span><span class="p">:</span> <span class="n">ActorState</span><span class="p">,</span> <span class="n">end_state</span><span class="p">:</span> <span class="n">ActorState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="c1"># distance traveled on the xy plane</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span>
        <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="p">(</span><span class="n">begin_state</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">end_state</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="o">+</span> <span class="p">((</span><span class="n">begin_state</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">end_state</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</section>
<section id="adding-the-optimizer-to-main">
<h3>Adding the optimizer to main<a class="headerlink" href="#adding-the-optimizer-to-main" title="Permalink to this heading"></a></h3>
<p>You can now add the finished optimizer to your <code class="docutils literal notranslate"><span class="pre">main</span></code> function.
You will also need to add some extra constants.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># optimize.py</span>

<span class="kn">import</span> <span class="nn">multineat</span>
<span class="kn">from</span> <span class="nn">revolve2.core.optimization</span> <span class="kn">import</span> <span class="n">DbId</span>
<span class="kn">from</span> <span class="nn">genotype</span> <span class="kn">import</span> <span class="n">random</span> <span class="k">as</span> <span class="n">random_genotype</span>
<span class="kn">from</span> <span class="nn">optimizer</span> <span class="kn">import</span> <span class="n">Optimizer</span>

<span class="c1"># ...</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># number of initial mutations for body and brain CPPNWIN networks</span>
    <span class="n">NUM_INITIAL_MUTATIONS</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="n">SIMULATION_TIME</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">SAMPLING_FREQUENCY</span> <span class="o">=</span> <span class="mi">60</span>
    <span class="n">CONTROL_FREQUENCY</span> <span class="o">=</span> <span class="mi">5</span>

    <span class="c1"># ...</span>

    <span class="c1"># unique database identifier for optimizer</span>
    <span class="n">db_id</span> <span class="o">=</span> <span class="n">DbId</span><span class="o">.</span><span class="n">root</span><span class="p">(</span><span class="s2">&quot;optmodular&quot;</span><span class="p">)</span>

    <span class="c1"># multineat innovation databases</span>
    <span class="n">innov_db_body</span> <span class="o">=</span> <span class="n">multineat</span><span class="o">.</span><span class="n">InnovationDatabase</span><span class="p">()</span>
    <span class="n">innov_db_brain</span> <span class="o">=</span> <span class="n">multineat</span><span class="o">.</span><span class="n">InnovationDatabase</span><span class="p">()</span>

    <span class="n">initial_population</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">random_genotype</span><span class="p">(</span><span class="n">innov_db_body</span><span class="p">,</span> <span class="n">innov_db_brain</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">NUM_INITIAL_MUTATIONS</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">POPULATION_SIZE</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">maybe_optimizer</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Optimizer</span><span class="o">.</span><span class="n">from_database</span><span class="p">(</span>
        <span class="n">database</span><span class="o">=</span><span class="n">database</span><span class="p">,</span>
        <span class="n">db_id</span><span class="o">=</span><span class="n">db_id</span><span class="p">,</span>
        <span class="n">innov_db_body</span><span class="o">=</span><span class="n">innov_db_body</span><span class="p">,</span>
        <span class="n">innov_db_brain</span><span class="o">=</span><span class="n">innov_db_brain</span><span class="p">,</span>
        <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">maybe_optimizer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">maybe_optimizer</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Optimizer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
            <span class="n">database</span><span class="o">=</span><span class="n">database</span><span class="p">,</span>
            <span class="n">db_id</span><span class="o">=</span><span class="n">db_id</span><span class="p">,</span>
            <span class="n">initial_population</span><span class="o">=</span><span class="n">initial_population</span><span class="p">,</span>
            <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span>
            <span class="n">innov_db_body</span><span class="o">=</span><span class="n">innov_db_body</span><span class="p">,</span>
            <span class="n">innov_db_brain</span><span class="o">=</span><span class="n">innov_db_brain</span><span class="p">,</span>
            <span class="n">simulation_time</span><span class="o">=</span><span class="n">SIMULATION_TIME</span><span class="p">,</span>
            <span class="n">sampling_frequency</span><span class="o">=</span><span class="n">SAMPLING_FREQUENCY</span><span class="p">,</span>
            <span class="n">control_frequency</span><span class="o">=</span><span class="n">CONTROL_FREQUENCY</span><span class="p">,</span>
            <span class="n">num_generations</span><span class="o">=</span><span class="n">NUM_GENERATIONS</span><span class="p">,</span>
            <span class="n">offspring_size</span><span class="o">=</span><span class="n">OFFSPRING_SIZE</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting optimization process..&quot;</span><span class="p">)</span>

    <span class="k">await</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished optimizing.&quot;</span><span class="p">)</span>

<span class="c1"># ...</span>
</pre></div>
</div>
</section>
</section>
<section id="running-and-analyzing">
<h2>Running and analyzing<a class="headerlink" href="#running-and-analyzing" title="Permalink to this heading"></a></h2>
<p>Run <code class="docutils literal notranslate"><span class="pre">optimize.py</span></code> and your robots will evolve.
Depending on your parameters this can take quite a long time.
The example parameters used in this example will result in a fast optimization process but yield bad robots.
To actually see the robots you can set <code class="docutils literal notranslate"><span class="pre">headless=False</span></code> in your optimizer when creating the runner.</p>
<a class="reference internal image-reference" href="../_images/optimize_locomotion_simulator.gif"><img alt="../_images/optimize_locomotion_simulator.gif" src="../_images/optimize_locomotion_simulator.gif" style="width: 100%;" /></a>
<p>You can analyze the results using the same scripts as from the previous optimization tutorial.
Depending on your evolution parameters and the parameters provided to the plotting script it will look similar to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">revolve2_plot_ea_fitness_float</span> <span class="o">./</span><span class="n">database</span> <span class="mi">0</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/optimize_locomotion_analysis.png"><img alt="../_images/optimize_locomotion_analysis.png" src="../_images/optimize_locomotion_analysis.png" style="width: 100%;" /></a>
</section>
<section id="rerunning">
<h2>Rerunning<a class="headerlink" href="#rerunning" title="Permalink to this heading"></a></h2>
<p>Using the <code class="docutils literal notranslate"><span class="pre">ModularRobotRerunner</span></code> from the previous Isaac Gym tutorial you can visualize your best robot.
The script below selects the best robot from the database and lets it walk:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># rerun_best.py</span>

<span class="kn">from</span> <span class="nn">genotype</span> <span class="kn">import</span> <span class="n">GenotypeSerializer</span><span class="p">,</span> <span class="n">develop</span>
<span class="kn">from</span> <span class="nn">revolve2.runners.mujoco</span> <span class="kn">import</span> <span class="n">ModularRobotRerunner</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.asyncio.session</span> <span class="kn">import</span> <span class="n">AsyncSession</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.future</span> <span class="kn">import</span> <span class="n">select</span>

<span class="kn">from</span> <span class="nn">revolve2.core.database</span> <span class="kn">import</span> <span class="n">open_async_database_sqlite</span>
<span class="kn">from</span> <span class="nn">revolve2.core.database.serializers</span> <span class="kn">import</span> <span class="n">DbFloat</span>
<span class="kn">from</span> <span class="nn">revolve2.core.optimization.ea.generic_ea</span> <span class="kn">import</span> <span class="n">DbEAOptimizerIndividual</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">open_async_database_sqlite</span><span class="p">(</span><span class="s2">&quot;./database&quot;</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">AsyncSession</span><span class="p">(</span><span class="n">db</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">best_individual</span> <span class="o">=</span> <span class="p">(</span>
            <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="n">select</span><span class="p">(</span><span class="n">DbEAOptimizerIndividual</span><span class="p">,</span> <span class="n">DbFloat</span><span class="p">)</span>
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">DbEAOptimizerIndividual</span><span class="o">.</span><span class="n">fitness_id</span> <span class="o">==</span> <span class="n">DbFloat</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">DbFloat</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

        <span class="k">assert</span> <span class="n">best_individual</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fitness: </span><span class="si">{</span><span class="n">best_individual</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">genotype</span> <span class="o">=</span> <span class="p">(</span>
            <span class="k">await</span> <span class="n">GenotypeSerializer</span><span class="o">.</span><span class="n">from_database</span><span class="p">(</span>
                <span class="n">session</span><span class="p">,</span> <span class="p">[</span><span class="n">best_individual</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">genotype_id</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">rerunner</span> <span class="o">=</span> <span class="n">ModularRobotRerunner</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">rerunner</span><span class="o">.</span><span class="n">rerun</span><span class="p">(</span><span class="n">develop</span><span class="p">(</span><span class="n">genotype</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">asyncio</span>

    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="contributing">
<h2>Contributing<a class="headerlink" href="#contributing" title="Permalink to this heading"></a></h2>
<p>This marks the end of this tutorial. Feedback and contributions are welcome at Revolve2’s code repository.</p>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Computational Intelligence Group, Vrije Universiteit Amsterdam &amp; Contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>